# ========================================================================
# Pandora Central Monitor Server - Nginx Configuration  
# ========================================================================
# High security: Admin access only
# ========================================================================

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;
    
    sendfile on;
    tcp_nopush on;
    keepalive_timeout 65;
    
    # Logging
    log_format central '$remote_addr - [$time_local] "$request" $status "$http_user_agent"';
    access_log /var/log/nginx/central_access.log central;
    error_log /var/log/nginx/central_error.log warn;
    
    # ====================================================================
    # SERVER: HTTPS Only (Port 443) - Admin Dashboard
    # ====================================================================
    server {
        listen 443 ssl http2;
        listen [::]:443 ssl http2;
        server_name _;
        
        # SSL Configuration
        ssl_certificate /etc/nginx/ssl/cert.pem;
        ssl_certificate_key /etc/nginx/ssl/key.pem;
        ssl_protocols TLSv1.2 TLSv1.3;
        ssl_ciphers HIGH:!aNULL:!MD5;
        
        # Security Headers
        add_header Strict-Transport-Security "max-age=31536000" always;
        add_header X-Frame-Options "DENY" always;
        add_header X-Content-Type-Options "nosniff" always;
        
        # IP Whitelist (Change to your admin IPs)
        # allow 192.168.1.100;  # Admin IP
        # allow 10.0.0.0/24;    # Admin network
        # deny all;
        
        # Dashboard (Central Monitor - Flask)
        location / {
            proxy_pass http://127.0.0.1:5000/;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # Admin API (Backend-admin - FastAPI)
        location /api/admin/ {
            proxy_pass http://127.0.0.1:8002/;
            proxy_http_version 1.1;
            
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-API-Key $http_x_api_key;
            
            proxy_connect_timeout 30s;
            proxy_send_timeout 30s;
            proxy_read_timeout 30s;
        }
        
        # Health check
        location /health {
            access_log off;
            return 200 "Central Monitor OK\n";
            add_header Content-Type text/plain;
        }
    }
}

