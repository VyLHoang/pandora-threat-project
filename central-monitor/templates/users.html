{% extends "base.html" %}

{% block title %}User Monitoring - Pandora Admin{% endblock %}

{% block content %}
<div class="page-header">
    <h1>üë• User Monitoring</h1>
    <p>Real-time user activity and statistics (READ-ONLY access)</p>
</div>

<!-- User Statistics Cards -->
<div class="stats-grid">
    <div class="stat-card">
        <div class="stat-icon">üë§</div>
        <div class="stat-value" id="total-users">-</div>
        <div class="stat-label">Total Users</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üü¢</div>
        <div class="stat-value" id="active-today">-</div>
        <div class="stat-label">Active Today</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üÜï</div>
        <div class="stat-value" id="new-week">-</div>
        <div class="stat-label">New This Week</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üîç</div>
        <div class="stat-value" id="total-scans">-</div>
        <div class="stat-label">Total Scans</div>
    </div>
    
    <div class="stat-card">
        <div class="stat-icon">üìä</div>
        <div class="stat-value" id="scans-today">-</div>
        <div class="stat-label">Scans Today</div>
    </div>
</div>

<!-- Recent Users Section -->
<div class="section-header">
    <h2>üìã Recent Users</h2>
    <div class="auto-refresh-notice">
        Auto-refresh: <span id="countdown-users">30</span>s
    </div>
</div>

<div class="table-container">
    <table class="users-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Username</th>
                <th>Email</th>
                <th>Status</th>
                <th>Created</th>
                <th>Last Login</th>
                <th>Scans</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody id="users-tbody">
            <tr>
                <td colspan="8" style="text-align: center; padding: 40px;">
                    Loading users...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Recent Scans Section -->
<div class="section-header">
    <h2>üîç Recent Scans (All Users)</h2>
</div>

<div class="table-container">
    <table class="scans-table">
        <thead>
            <tr>
                <th>Time</th>
                <th>User ID</th>
                <th>Type</th>
                <th>Target</th>
                <th>Location</th>
            </tr>
        </thead>
        <tbody id="scans-tbody">
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px;">
                    Loading scans...
                </td>
            </tr>
        </tbody>
    </table>
</div>

<!-- Suspicious Activity Section -->
<div class="section-header">
    <h2>‚ö†Ô∏è Suspicious Activity (Last 24h)</h2>
</div>

<div class="suspicious-section" id="suspicious-section">
    <p class="loading-text">Loading suspicious activity...</p>
</div>

<style>
/* Pandora Theme - Black/Yellow/White */
.stats-grid {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 20px;
    margin-bottom: 40px;
}

.stat-card {
    background: #000;  /* N·ªÅn ƒëen thu·∫ßn */
    border: 3px solid #FFD700;
    color: #FFD700;
    padding: 25px;
    border-radius: 12px;
    text-align: center;
    box-shadow: 0 4px 15px rgba(255, 215, 0, 0.3);
}

.stat-icon {
    font-size: 2.5em;
    margin-bottom: 10px;
    filter: drop-shadow(0 0 5px #FFD700);
}

.stat-value {
    font-size: 2.5em;
    font-weight: bold;
    margin: 10px 0;
    color: #FFD700;
    text-shadow: 0 0 10px rgba(255, 215, 0, 0.5);
}

.stat-label {
    font-size: 0.9em;
    color: #FFF;
    text-transform: uppercase;
    letter-spacing: 1px;
    font-weight: 600;
}

.users-table, .scans-table {
    width: 100%;
    border-collapse: collapse;
    background: #1a1a1a;
    border: 3px solid #FFD700;
    border-radius: 8px;
    overflow: hidden;
}

.users-table th, .scans-table th {
    background: #000;
    color: #FFD700;
    padding: 15px;
    text-align: left;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 1px;
    border-bottom: 3px solid #FFD700;
}

.users-table td, .scans-table td {
    padding: 12px 15px;
    border-bottom: 1px solid #333;
    color: #FFF;
    font-family: 'Courier New', monospace;
}

.users-table tbody tr:hover, .scans-table tbody tr:hover {
    background: #2a2a2a;
    box-shadow: inset 0 0 10px rgba(255, 215, 0, 0.1);
}

.status-active {
    color: #00ff00;
    font-weight: 700;
    text-shadow: 0 0 5px #00ff00;
}

.status-inactive {
    color: #ff4444;
    font-weight: 700;
    text-shadow: 0 0 5px #ff4444;
}

.btn-view {
    background: #FFD700;
    color: #000;
    border: 2px solid #FFD700;
    padding: 8px 16px;
    border-radius: 6px;
    cursor: pointer;
    font-size: 0.85em;
    font-weight: 700;
    transition: all 0.3s;
    text-transform: uppercase;
}

.btn-view:hover {
    background: #000;
    color: #FFD700;
    transform: translateY(-2px);
    box-shadow: 0 4px 12px rgba(255, 215, 0, 0.5);
}

.suspicious-section {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
    gap: 15px;
}

.suspicious-card {
    background: #1a1a1a;
    border: 3px solid #ff4444;
    color: #FFF;
    padding: 20px;
    border-radius: 8px;
    box-shadow: 0 4px 12px rgba(255, 68, 68, 0.3);
}

.suspicious-card h4 {
    margin: 0 0 10px 0;
    font-size: 1.2em;
    color: #ff4444;
    text-shadow: 0 0 10px rgba(255, 68, 68, 0.5);
}

.suspicious-card p {
    margin: 5px 0;
    color: #FFF;
    font-family: 'Courier New', monospace;
}

.loading-text {
    text-align: center;
    padding: 40px;
    color: #FFD700;
    font-family: 'Courier New', monospace;
    font-size: 1.1em;
}

.badge {
    background: #FFD700;
    color: #000;
    padding: 4px 10px;
    border-radius: 4px;
    font-size: 0.85em;
    font-weight: 700;
    text-transform: uppercase;
}

code {
    background: #000;
    color: #00ff00;
    padding: 4px 8px;
    border-radius: 4px;
    font-family: 'Courier New', monospace;
    border: 1px solid #FFD700;
}

strong {
    color: #FFD700;
    text-shadow: 0 0 5px rgba(255, 215, 0, 0.3);
}
</style>

<script>
let countdownUsers = 30;
let intervalUsers;

async function loadUserStats() {
    try {
        const response = await fetch('/api/users/stats');
        const data = await response.json();
        
        document.getElementById('total-users').textContent = data.total_users || 0;
        document.getElementById('active-today').textContent = data.active_users_today || 0;
        document.getElementById('new-week').textContent = data.new_users_this_week || 0;
        document.getElementById('total-scans').textContent = data.total_scans || 0;
        document.getElementById('scans-today').textContent = data.scans_today || 0;
    } catch (error) {
        console.error('Error loading stats:', error);
    }
}

async function loadUsers() {
    try {
        const response = await fetch('/api/users/users?limit=20');
        const users = await response.json();
        
        const tbody = document.getElementById('users-tbody');
        if (users.length === 0) {
            tbody.innerHTML = '<tr><td colspan="8" style="text-align: center; padding: 40px;">No users found</td></tr>';
            return;
        }
        
        tbody.innerHTML = users.map(user => `
            <tr>
                <td>${user.id}</td>
                <td><strong>${user.username}</strong></td>
                <td>${user.email}</td>
                <td class="${user.is_active ? 'status-active' : 'status-inactive'}">
                    ${user.is_active ? 'üü¢ Active' : 'üî¥ Inactive'}
                </td>
                <td>${new Date(user.created_at).toLocaleString()}</td>
                <td>${user.last_login ? new Date(user.last_login).toLocaleString() : 'Never'}</td>
                <td><strong>${user.total_scans}</strong></td>
                <td>
                    <button class="btn-view" onclick="viewUserScans(${user.id})">
                        View Scans
                    </button>
                </td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading users:', error);
        document.getElementById('users-tbody').innerHTML = 
            '<tr><td colspan="8" style="text-align: center; color: red;">Error loading users</td></tr>';
    }
}

async function loadRecentScans() {
    try {
        const response = await fetch('/api/users/scans/recent?limit=15');
        const scans = await response.json();
        
        const tbody = document.getElementById('scans-tbody');
        if (scans.length === 0) {
            tbody.innerHTML = '<tr><td colspan="5" style="text-align: center; padding: 40px;">No scans found</td></tr>';
            return;
        }
        
        tbody.innerHTML = scans.map(scan => `
            <tr>
                <td>${new Date(scan.created_at).toLocaleString()}</td>
                <td><strong>#${scan.user_id}</strong></td>
                <td><span class="badge">${scan.scan_type}</span></td>
                <td><code>${scan.ip_address || scan.file_hash || 'N/A'}</code></td>
                <td>${scan.geoip_city || 'Unknown'}, ${scan.geoip_country || 'Unknown'}</td>
            </tr>
        `).join('');
    } catch (error) {
        console.error('Error loading scans:', error);
    }
}

async function loadSuspicious() {
    try {
        const response = await fetch('/api/users/scans/suspicious?hours=24');
        const data = await response.json();
        
        const section = document.getElementById('suspicious-section');
        if (data.total_suspicious === 0) {
            section.innerHTML = '<p class="loading-text">‚úÖ No suspicious activity detected</p>';
            return;
        }
        
        section.innerHTML = data.suspicious_ips.map(item => `
            <div class="suspicious-card">
                <h4>üö® ${item.ip_address}</h4>
                <p><strong>${item.scan_count}</strong> scans in ${item.time_window}</p>
                <p>üìç ${item.country || 'Unknown'}</p>
            </div>
        `).join('');
    } catch (error) {
        console.error('Error loading suspicious:', error);
    }
}

function viewUserScans(userId) {
    // TODO: Open modal or navigate to user detail page
    alert(`Viewing scans for user #${userId}\n\nEndpoint: /api/v1/users/users/${userId}/scans`);
}

function startCountdown() {
    const countdownEl = document.getElementById('countdown-users');
    intervalUsers = setInterval(() => {
        countdownUsers--;
        countdownEl.textContent = countdownUsers;
        
        if (countdownUsers <= 0) {
            countdownUsers = 30;
            loadAllData();
        }
    }, 1000);
}

function loadAllData() {
    loadUserStats();
    loadUsers();
    loadRecentScans();
    loadSuspicious();
}

// Initial load
window.addEventListener('DOMContentLoaded', () => {
    loadAllData();
    startCountdown();
});

// Cleanup on page unload
window.addEventListener('beforeunload', () => {
    if (intervalUsers) clearInterval(intervalUsers);
});
</script>
{% endblock %}

